<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ubike çµé‡‘åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #111827; color: white; }
        .card { background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(8px); border: 1px solid #374151; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-2xl font-bold text-yellow-400 text-center mb-6">Ubike 5å…ƒçµäººç³»çµ±</h1>
        <button onclick="fetchData()" id="btn" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-xl mb-6 shadow-lg active:scale-95 transition">
            ğŸ” æƒææœ€è¿‘çå‹µç«™é»
        </button>
        <div id="status" class="text-center text-gray-400 text-sm mb-4">ç³»çµ±å°±ç·’</div>
        <div id="list" class="space-y-4"></div>
    </div>

    <script>
        async function fetchData() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const list = document.getElementById('list');
            
            btn.disabled = true;
            status.innerText = "æ­£åœ¨å–å¾—ä½ç½®èˆ‡ç©¿é€ CORS é™åˆ¶...";
            list.innerHTML = "";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                
                try {
                    // ä½¿ç”¨ AllOrigins ä»£ç†å¾¹åº•è§£æ±ºæŠ“ä¸åˆ°è³‡æ–™çš„å•é¡Œ
                    const target = "https://tcgbusfs.blob.core.windows.net/dotddo/youbike/v2/youbike_immediate.json";
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}&t=${Date.now()}`;
                    
                    const response = await fetch(proxyUrl);
                    const wrapper = await response.json();
                    const stations = JSON.parse(wrapper.contents); // é€™è£¡è¦è§£æå…§å®¹

                    const results = stations.map(s => {
                        const d = Math.sqrt(Math.pow(s.latitude - latitude, 2) + Math.pow(s.longitude - longitude, 2)) * 111;
                        return { ...s, dist: d };
                    })
                    .filter(s => s.available_return_bikes === 0 || s.available_rent_bikes === 0)
                    .sort((a, b) => a.dist - b.dist)
                    .slice(0, 10);

                    results.forEach(s => {
                        const isFull = s.available_return_bikes === 0;
                        const div = document.createElement('div');
                        div.className = "card p-4 rounded-xl flex justify-between items-center border-l-4 " + (isFull ? "border-red-500" : "border-green-500");
                        div.innerHTML = `
                            <div>
                                <div class="font-bold">${s.sna.split('_')[1]}</div>
                                <div class="text-xs text-gray-400">è·é›¢ç´„ ${(s.dist * 1000).toFixed(0)}m</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black ${isFull ? 'text-red-500' : 'text-green-500'}">${s.available_rent_bikes}/${s.total}</div>
                                <div class="text-[10px]">${isFull ? 'æ»¿ç«™å–è»Š' : 'ç©ºç«™é‚„è»Š'}</div>
                            </div>
                        `;
                        div.onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}`);
                        list.appendChild(div);
                    });
                    status.innerText = "æƒææˆåŠŸï¼é»æ“Šå¡ç‰‡é–‹å•Ÿå°èˆª";
                } catch (e) {
                    status.innerText = "æŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèª API ç‹€æ…‹";
                    console.error(e);
                } finally {
                    btn.disabled = false;
                }
            }, (err) => {
                status.innerText = "å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿ GPS";
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
