<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouBike çµé‡‘é›·é”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-glow { box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto">
        <header class="text-center py-6">
            <h1 class="text-3xl font-black text-yellow-400 italic tracking-tighter">UBIKE HUNTER</h1>
            <div id="status-msg" class="text-[10px] text-slate-500 mt-2 uppercase tracking-widest font-mono">System Ready</div>
        </header>

        <div class="glass p-6 rounded-3xl mb-6 shadow-2xl border-t border-white/10">
            <button onclick="startHunting()" id="main-btn" class="btn-glow w-full bg-yellow-400 hover:bg-yellow-500 text-slate-900 font-black py-5 rounded-2xl transition-all transform active:scale-95">
                ğŸ›°ï¸ å•Ÿå‹•å…¨åŸŸæœå°‹
            </button>
        </div>

        <div id="result-list" class="space-y-4 pb-10">
            </div>
    </div>

    <script>
        async function startHunting() {
            const btn = document.getElementById('main-btn');
            const status = document.getElementById('status-msg');
            const list = document.getElementById('result-list');
            
            btn.disabled = true;
            btn.innerText = "æƒæä¸­...";
            status.innerText = "æ­£åœ¨å–å¾— GPS æ¬Šé™...";
            list.innerHTML = "";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                status.innerText = `åº§æ¨™: ${lat.toFixed(3)}, ${lon.toFixed(3)} | è«‹æ±‚ API...`;

                try {
                    // æ›´æ›ä»£ç†ä¼ºæœå™¨ç‚º corsproxy.io (ç›®å‰è¼ƒç©©å®š)
                    const target = "https://tcgbusfs.blob.core.windows.net/dotddo/youbike/v2/youbike_immediate.json";
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(target)}`;
                    
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error("ä»£ç†ä¼ºæœå™¨å¿™ç¢Œä¸­");
                    
                    const stations = await response.json();

                    // è¨ˆç®—è·é›¢èˆ‡ç¯©é¸ (æ»¿ç«™æˆ–ç©ºç«™)
                    const bonusStations = stations.map(s => {
                        const d = Math.sqrt(Math.pow(s.latitude - lat, 2) + Math.pow(s.longitude - lon, 2)) * 111;
                        return { ...s, dist: d };
                    })
                    .filter(s => s.available_return_bikes === 0 || s.available_rent_bikes === 0)
                    .sort((a, b) => a.dist - b.dist)
                    .slice(0, 15);

                    if (bonusStations.length === 0) {
                        list.innerHTML = `<div class="text-center text-slate-500 py-10 italic">é™„è¿‘æš«ç„¡çå‹µç«™é»</div>`;
                    }

                    bonusStations.forEach(s => {
                        const isFull = s.available_return_bikes === 0;
                        const card = document.createElement('div');
                        card.className = `glass p-5 rounded-2xl border-l-4 flex justify-between items-center transition-all active:bg-white/5 ${isFull ? 'border-red-500' : 'border-green-500'}`;
                        card.innerHTML = `
                            <div>
                                <div class="font-bold text-lg">${s.sna.replace('YouBike2.0_', '')}</div>
                                <div class="text-[10px] text-slate-400">è·é›¢ ${(s.dist * 1000).toFixed(0)}m</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black ${isFull ? 'text-red-500' : 'text-green-500'}">${s.available_rent_bikes}/${s.total}</div>
                                <div class="text-[9px] font-bold text-slate-500 uppercase">${isFull ? 'æ»¿ç«™å–è»Š' : 'ç©ºç«™é‚„è»Š'}</div>
                            </div>
                        `;
                        card.onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}`);
                        list.appendChild(card);
                    });

                    status.innerText = "æƒææˆåŠŸï¼";
                } catch (e) {
                    console.error(e);
                    status.innerText = "ä»£ç†ä¼ºæœå™¨è¶…æ™‚ï¼Œè«‹é»æ“ŠæŒ‰éˆ•é‡è©¦";
                    alert("ç›®å‰å…è²»é€šé“æ“æ“ ï¼Œè‹¥å¤šæ¬¡å¤±æ•—ï¼Œå»ºè­°æ›å€‹ç¶²è·¯ç’°å¢ƒæˆ–ç¨å¾Œå†è©¦ã€‚");
                } finally {
                    btn.disabled = false;
                    btn.innerText = "ğŸ›°ï¸ é‡æ–°æƒæ";
                }
            }, (err) => {
                alert("è«‹å‹™å¿…åœ¨æ‰‹æ©Ÿè¨­å®šä¸­å…è¨±ç€è¦½å™¨å­˜å–ã€Œä½ç½®ã€æ¬Šé™ï¼");
                btn.disabled = false;
                btn.innerText = "ğŸ›°ï¸ é‡æ–°æƒæ";
            });
        }
    </script>
</body>
</html>
