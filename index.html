<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouBike çµé‡‘åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }
        .gradient-text {
            background: linear-gradient(45deg, #facc15, #fb923c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .pulse-yellow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .tab-active { border-bottom: 3px solid #facc15; color: #facc15; }
    </style>
</head>
<body class="safe-area-inset-bottom">

    <div class="max-w-md mx-auto min-h-screen flex flex-col p-4">
        <header class="py-6 text-center animate__animated animate__fadeInDown">
            <h1 class="text-3xl font-black gradient-text tracking-tight">UBIKE HUNTER ğŸ’°</h1>
            <p class="text-slate-400 text-sm mt-1">å³æ™‚æƒæ 5 å…ƒèª¿åº¦ç«™é»</p>
        </header>

        <div class="glass-card p-6 mb-6 shadow-2xl animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-4">
                <span id="loc-tag" class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">ç­‰å¾…å®šä½...</span>
                <span id="update-time" class="text-[10px] text-slate-500">å°šæœªæ›´æ–°</span>
            </div>
            <button onclick="scan()" id="scan-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-slate-900 font-bold py-4 rounded-2xl transition-all transform active:scale-95 shadow-lg shadow-yellow-400/20">
                ç«‹å³æƒæå‘¨é‚Šç«™é»
            </button>
        </div>

        <div class="flex-1 flex flex-col animate__animated animate__fadeInUp">
            <div class="flex border-b border-slate-700 mb-4">
                <button onclick="showTab('full')" id="tab-full" class="flex-1 py-3 font-bold tab-active">ğŸ”´ å»å–è»Š (æ»¿ç«™)</button>
                <button onclick="showTab('empty')" id="tab-empty" class="flex-1 py-3 font-bold text-slate-500">ğŸŸ¢ å»é‚„è»Š (ç©ºç«™)</button>
            </div>

            <div id="loading" class="hidden py-10 text-center">
                <div class="inline-block w-8 h-8 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-slate-400 text-sm">æ­£åœ¨è¨ˆç®—æœ€ä½³çµé‡‘è·¯ç·š...</p>
            </div>

            <div id="list-container" class="space-y-3 pb-20">
                </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let userCoords = null;

        async function scan() {
            const btn = document.getElementById('scan-btn');
            const loader = document.getElementById('loading');
            const list = document.getElementById('list-container');
            
            btn.disabled = true;
            btn.innerText = "æœå°‹ä¸­...";
            loader.classList.remove('hidden');
            list.innerHTML = "";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                userCoords = pos.coords;
                document.getElementById('loc-tag').innerText = "ğŸ“ å·²å®šä½æˆåŠŸ";
                await fetchData();
            }, (err) => {
                alert("è«‹é–‹å•Ÿå®šä½æ¬Šé™æ‰èƒ½è¨ˆç®—è·é›¢ï¼");
                btn.disabled = false;
                btn.innerText = "ç«‹å³æƒæå‘¨é‚Šç«™é»";
                loader.classList.add('hidden');
            });
        }

        async function fetchData() {
            try {
                // ä½¿ç”¨ TDX API çš„æ›¿ä»£æ–¹æ¡ˆæˆ– TDX ä»£ç† (é€™è£¡ç”¨å°åŒ—å¸‚å…¬é–‹è³‡æ–™ä½œç¯„ä¾‹)
                const res = await fetch('https://tcgbusfs.blob.core.windows.net/dotddo/youbike/v2/youbike_immediate.json');
                rawData = await res.json();
                render('full');
                document.getElementById('update-time').innerText = "æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString();
            } catch (e) {
                alert("è³‡æ–™æŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š");
            } finally {
                document.getElementById('scan-btn').disabled = false;
                document.getElementById('scan-btn').innerText = "é‡æ–°æƒæ";
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function render(type) {
            const list = document.getElementById('list-container');
            list.innerHTML = "";

            const filtered = rawData.map(s => ({
                ...s,
                dist: Math.hypot(s.latitude - userCoords.latitude, s.longitude - userCoords.longitude) * 111 // ç°¡å–®è·é›¢æ›ç®—
            }))
            .filter(s => type === 'full' ? s.available_return_bikes <= 1 : s.available_rent_bikes <= 1)
            .sort((a, b) => a.dist - b.dist)
            .slice(0, 15);

            filtered.forEach(s => {
                const card = document.createElement('div');
                card.className = "glass-card p-5 flex justify-between items-center animate__animated animate__fadeInUp";
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-lg">${s.sna.split('_')[1]}</div>
                        <div class="text-xs text-slate-500 mt-1">è·é›¢ç´„ ${s.dist.toFixed(2)} km</div>
                        <div class="mt-2">
                            <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">ç¸½è»Šä½ ${s.total}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black ${type === 'full' ? 'text-red-500' : 'text-green-500'}">
                            ${type === 'full' ? s.available_rent_bikes : s.available_return_bikes}
                        </div>
                        <div class="text-[10px] font-bold text-slate-500 uppercase">${type === 'full' ? 'å¯å€Ÿè»Šè¼›' : 'å‰©é¤˜ç©ºä½'}</div>
                    </div>
                `;
                // é»æ“Šå¡ç‰‡è·³è½‰ Google åœ°åœ–å°èˆª
                card.onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.latitude},${s.longitude}`);
                list.appendChild(card);
            });
        }

        function showTab(type) {
            document.getElementById('tab-full').className = `flex-1 py-3 font-bold ${type === 'full' ? 'tab-active' : 'text-slate-500'}`;
            document.getElementById('tab-empty').className = `flex-1 py-3 font-bold ${type === 'empty' ? 'tab-active' : 'text-slate-500'}`;
            if(rawData.length > 0) render(type);
        }
    </script>
</body>

</html>
